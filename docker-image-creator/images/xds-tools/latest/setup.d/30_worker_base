#!/bin/bash

# add some cool base tools
apt-get install -y man tree curl screen 

# add the build user
useradd -c "Builder" -d $JENKINSUSER_HOME -G sudo -m -U -s /bin/bash -u $JENKINSUSER_UID $JENKINSUSER
echo $JENKINSUSER:$JENKINSUSER_PASSWORD | chpasswd 

# generate an extra environment file sourced by bashrc
for k in	JENKINSUSER JENKINSUSER_UID JENKINSUSER_HOME \
			XDT_DIR \
			XDT_META XDT_DOWNLOADCACHE XDT_SSTATECACHE XDT_CCACHE XDT_BUILD XDT_WORKSPACE XDT_SOURCES XDT_SDK \
			; do
	v=${!k} # get value
	[[ "${v:0:1}" == "/" ]] && mkdir -p $v # create dir only if value starts with "/"
	echo "export $k=$v" >>/etc/xdtrc
done

mkdir -p $JENKINSUSER_HOME/bin
cat <<'EOF' >>$JENKINSUSER_HOME/.bashrc

# added by worker image creation script (docker-image-builder)
export PATH=~/bin:$PATH
[[ -f /etc/xdtrc ]] && . /etc/xdtrc

EOF

chown -R $JENKINSUSER:$JENKINSUSER $XDT_DIR
chown -R $JENKINSUSER:$JENKINSUSER $JENKINSUSER_HOME

